<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TestWeaver Agent Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --bg-elevated: #020617;
      --panel: #020617;
      --accent: #22c55e;
      --accent-soft: rgba(34, 197, 94, 0.12);
      --accent-strong: #16a34a;
      --border-subtle: #1f2937;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --font-sans: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: var(--font-sans);
      background: radial-gradient(circle at top left, #1f2937 0, #020617 40%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px;
    }

    .app {
      max-width: 1280px;
      width: 100%;
      background: linear-gradient(145deg, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.92));
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.9),
        0 28px 80px rgba(0, 0, 0, 0.75);
      display: grid;
      grid-template-columns: minmax(260px, 280px) minmax(0, 1fr);
      overflow: hidden;
    }

    /* Sidebar */
    .sidebar {
      background: radial-gradient(circle at top, rgba(34, 197, 94, 0.15), transparent 55%), #020617;
      border-right: 1px solid rgba(31, 41, 55, 0.9);
      padding: 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #bbf7d0, #22c55e, #16a34a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 20px;
      color: #022c22;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .brand-text-main {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .brand-text-sub {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.12em;
    }

    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .sidebar-card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 16px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 10px 12px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .field label {
      font-size: 11px;
      color: var(--text-muted);
    }

    .field input {
      appearance: none;
      background: #020617;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 7px 10px;
      font-size: 12px;
      color: var(--text-main);
      outline: none;
    }

    .field input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.3);
    }

    .hint {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
      line-height: 1.4;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
    }

    .pill {
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 4px 9px;
      font-size: 11px;
      color: var(--text-muted);
      background: #020617;
      cursor: pointer;
    }

    .pill:hover {
      border-color: var(--accent);
      color: #bbf7d0;
    }

    /* Main area */
    .main {
      display: flex;
      flex-direction: column;
      background: radial-gradient(circle at top right, rgba(34, 197, 94, 0.08), transparent 45%),
                  radial-gradient(circle at bottom, rgba(8, 47, 73, 0.4), #020617 70%);
    }

    .main-header {
      padding: 14px 18px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .main-header-left span:first-child {
      font-size: 14px;
      font-weight: 500;
    }

    .main-header-left span:last-child {
      font-size: 12px;
      color: var(--text-muted);
    }

    .status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 9px;
      border-radius: 999px;
      background: rgba(21, 128, 61, 0.12);
      border: 1px solid rgba(34, 197, 94, 0.4);
      font-size: 11px;
      color: #bbf7d0;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(22, 163, 74, 0.45);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 4px;
      padding: 8px 14px 0 14px;
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
    }

    .tab {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px 999px 0 0;
      cursor: pointer;
      border: 1px solid transparent;
      border-bottom: none;
      color: var(--text-muted);
      background: transparent;
    }

    .tab.active {
      color: #e5e7eb;
      background: #020617;
      border-color: rgba(55, 65, 81, 0.9);
      border-bottom: 1px solid #020617;
    }

    .tab-panel {
      display: none;
      flex: 1;
      padding: 10px 16px 12px 16px;
      overflow: hidden;
    }

    .tab-panel.active {
      display: flex;
      flex-direction: column;
    }

    /* Chat panel */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding-right: 4px;
      scroll-behavior: smooth;
    }

    .chat-empty {
      margin: auto;
      text-align: center;
      max-width: 360px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .chat-empty h2 {
      font-size: 15px;
      color: var(--text-main);
      margin-bottom: 6px;
    }

    .prompt-chips {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: center;
    }

    .chip {
      padding: 5px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      font-size: 11px;
      background: #020617;
      color: var(--text-muted);
      cursor: pointer;
    }

    .chip:hover { border-color: var(--accent); color: #bbf7d0; }

    .msg-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .msg-row.user { justify-content: flex-end; }

    .msg-avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
      flex-shrink: 0;
    }

    .msg-avatar.agent {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(31, 41, 55, 0.9);
      color: #a5b4fc;
    }

    .msg-avatar.user {
      background: #1f2937;
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #e5e7eb;
    }

    .msg-bubble {
      max-width: 72%;
      padding: 9px 11px;
      border-radius: 18px;
      font-size: 13px;
      line-height: 1.45;
      border: 1px solid rgba(31, 41, 55, 0.9);
      white-space: pre-wrap;
    }

    .msg-row.user .msg-bubble {
      background: linear-gradient(135deg, #1f2937, #020617);
      border-bottom-right-radius: 4px;
    }

    .msg-row.agent .msg-bubble {
      background: rgba(15, 23, 42, 0.96);
      border-bottom-left-radius: 4px;
    }

    .msg-meta {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
      text-align: right;
    }

    .input-bar {
      margin-top: 8px;
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.95);
      border: 1px solid rgba(55, 65, 81, 0.9);
      padding: 6px 8px 6px 10px;
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .textarea-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    textarea {
      background: transparent;
      border: none;
      outline: none;
      resize: none;
      max-height: 160px;
      min-height: 20px;
      color: var(--text-main);
      font-size: 13px;
      font-family: var(--font-sans);
    }

    .input-hint {
      font-size: 10px;
      color: var(--text-muted);
    }

    .typing {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .dot {
      width: 4px; height: 4px; border-radius: 999px;
      background: var(--text-muted);
      animation: blink 1.2s infinite ease-in-out;
    }
    .dot:nth-child(2) { animation-delay: 0.2s; }
    .dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0%, 80%, 100% { opacity: 0.2; transform: translateY(0); }
      40% { opacity: 1; transform: translateY(-1px); }
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
      background: radial-gradient(circle at top left, #bbf7d0, #22c55e, #16a34a);
      color: #022c22;
      box-shadow:
        0 0 0 1px rgba(21, 128, 61, 0.6),
        0 10px 24px rgba(22, 163, 74, 0.6);
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.4;
      cursor: default;
      box-shadow: none;
    }

    .btn-secondary {
      background: #020617;
      color: var(--text-muted);
      border: 1px solid rgba(55, 65, 81, 0.9);
      box-shadow: none;
      border-radius: 999px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      color: #bbf7d0;
    }

    /* Generate Tests panel */
    .panel-section-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .panel {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 10px;
      height: 100%;
    }

    .panel-left, .panel-right {
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .textarea-small {
      min-height: 60px;
      max-height: 170px;
      font-size: 12px;
    }

    pre {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 12px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 8px 10px;
      font-family: Consolas, "Courier New", monospace;
      font-size: 12px;
      color: #e5e7eb;
      overflow: auto;
      max-height: 100%;
      white-space: pre;
    }

    .badge {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: rgba(31, 41, 55, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    /* RAG panel */
    .rag-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 10px;
      height: 100%;
    }

    .rag-card {
      background: rgba(15, 23, 42, 0.96);
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 10px 10px;
      font-size: 12px;
      color: var(--text-muted);
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-height: 0;
    }

    .rag-card header {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-main);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .rag-card-content {
      flex: 1;
      overflow: auto;
      font-size: 11px;
      line-height: 1.4;
    }

    input[type="file"] {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* --- Tables for RAG output --- */
    .table-wrap {
      width: 100%;
      overflow: auto;
      border: 1px solid rgba(31, 41, 55, 0.9);
      border-radius: 12px;
      background: rgba(2, 6, 23, 0.6);
    }

    table.rag-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    table.rag-table th,
    table.rag-table td {
      border-bottom: 1px solid rgba(31, 41, 55, 0.9);
      padding: 8px 8px;
      vertical-align: top;
      color: #e5e7eb;
    }

    table.rag-table th {
      position: sticky;
      top: 0;
      background: rgba(15, 23, 42, 0.95);
      text-align: left;
      font-weight: 600;
      color: #cbd5e1;
      z-index: 1;
    }

    table.rag-table tr:hover td {
      background: rgba(34, 197, 94, 0.06);
    }

    .cell-muted { color: #9ca3af; }
    .mono { font-family: Consolas, "Courier New", monospace; white-space: pre-wrap; word-break: break-word; }

    .small-btn {
      padding: 2px 8px;
      font-size: 11px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: #020617;
      color: #9ca3af;
      cursor: pointer;
    }
    .small-btn:hover {
      border-color: var(--accent);
      color: #bbf7d0;
    }

    @media (max-width: 900px) {
      body { padding: 8px; }
      .app { grid-template-columns: minmax(0, 1fr); }
      .sidebar { display: none; }
      .panel, .rag-grid { grid-template-columns: minmax(0, 1fr); }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <div class="brand-logo">TW</div>
        <div>
          <div class="brand-text-main">TestWeaver Agent</div>
          <div class="brand-text-sub">Code-aware QA Assistant</div>
        </div>
      </div>

      <section>
        <div class="sidebar-section-title">Connection</div>
        <div class="sidebar-card">
          <div class="field">
            <label for="baseUrl">Backend Base URL</label>
            <input id="baseUrl" type="text" value="http://localhost:9090" />
          </div>

          <div class="field">
            <label for="sessionId">Session ID</label>
            <input id="sessionId" type="text" />
          </div>
          <p class="hint">
            Same <code>session_id</code> is reused across chat, test generation and PDF ingest
            so your <code>TestWeaverAgent</code> can preserve context/memory.
          </p>
        </div>
      </section>

      <section>
        <div class="sidebar-section-title">Quick Prompts</div>
        <div class="sidebar-card">
          <div class="pill-row">
            <button class="pill" data-prompt="Generate JUnit 5 tests for TransactionService covering credit, debit, zero and negative amounts.">
              TransactionService tests
            </button>
            <button class="pill" data-prompt="From this Jira description, derive 5 high-value BDD scenarios.">
              Jira → BDD
            </button>
            <button class="pill" data-prompt="Review the latest PR and list missing edge-case tests.">
              PR test review
            </button>
          </div>
        </div>
      </section>

      <section>
        <div class="sidebar-section-title">Tips</div>
        <div class="sidebar-card">
          <p class="hint">
            • Use a stable <code>session_id</code> per user or Jira ticket.<br/>
            • Upload PDFs via RAG panel, then ask chat with
            <code>query_for_rag</code> filled automatically.
          </p>
        </div>
      </section>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="main-header">
        <div class="main-header-left">
          <span>TestWeaver Agent Console</span><br/>
          <span>Chat, generate tests, and manage RAG docs in one place.</span>
        </div>
        <div class="status">
          <span class="status-dot"></span>
          <span id="statusText">Idle</span>
        </div>
      </header>

      <div class="tabs">
        <button class="tab active" data-tab="chat">Chat</button>
        <button class="tab" data-tab="tests">Generate Tests</button>
        <button class="tab" data-tab="rag">RAG Tools</button>
      </div>

      <!-- CHAT PANEL -->
      <section id="tab-chat" class="tab-panel active">
        <div id="chatContainer" class="chat-container">
          <div id="chatRagHits" style="margin-top:10px;"></div>
          <div id="chatEmpty" class="chat-empty">
            <h2>Talk to your TestWeaver Agent</h2>
            <p>
              Ask for JUnit tests, PR reviews, or test ideas leveraging your RAG chunks.
            </p>
            <div class="prompt-chips">
              <button class="chip" data-prompt="Generate JUnit 5 tests for AccountController including success and failure paths.">
                JUnit for AccountController
              </button>
              <button class="chip" data-prompt="List boundary value test cases for this requirement.">
                Boundary value ideas
              </button>
            </div>
          </div>
        </div>

        <div style="margin-top: 6px; font-size: 11px; color: var(--text-muted); display: flex; gap: 10px; align-items: center;">
          <label style="display: flex; align-items: center; gap: 4px;">
            <input type="checkbox" id="useSameForRag" checked />
            Use same text as <code>query_for_rag</code>
          </label>
          <span>or</span>
          <input
            id="ragQueryInput"
            type="text"
            placeholder="Optional: override query_for_rag..."
            style="flex:1; background:#020617; border-radius:999px; border:1px solid rgba(55,65,81,0.9); padding:4px 8px; color:var(--text-main); font-size:11px;"
          />
        </div>

        <div class="input-bar">
          <div class="textarea-wrap">
            <textarea id="chatInput" rows="1" placeholder="Type a message for your agent..."></textarea>
            <div style="display:flex; justify-content:space-between; align-items:center;">
              <div class="input-hint">
                Enter to send, Shift+Enter for newline
              </div>
              <div id="typingIndicator" class="typing" style="display:none;">
                <span>Agent is thinking</span>
                <span class="dot"></span><span class="dot"></span><span class="dot"></span>
              </div>
            </div>
          </div>
          <button id="sendChatBtn" class="btn">
            <span>Send</span> <span>➤</span>
          </button>
        </div>
      </section>

      <!-- GENERATE TESTS PANEL -->
      <section id="tab-tests" class="tab-panel">
        <div class="panel">
          <div class="panel-left">
            <div class="panel-section-title">Generate JUnit Tests</div>
            <div class="field">
              <label for="servicePath">Service / Controller file path (in repo)</label>
              <input
                id="servicePath"
                type="text"
                placeholder="e.g. src/main/java/com/example/accounting/service/TransactionService.java"
              />
            </div>
            <div class="field">
              <label for="extraInstructions">Extra instructions (optional)</label>
              <textarea
                id="extraInstructions"
                class="textarea-small"
                placeholder="e.g. Include boundary tests for zero, negative, large amounts and concurrency scenarios."
              ></textarea>
            </div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:4px;">
              <button id="generateTestsBtn" class="btn">
                Generate Tests
              </button>
              <span id="testsStatus" class="hint"></span>
            </div>
            <p class="hint">
              Calls <code>POST /generate-tests</code> with <code>session_id</code>, <code>service_path</code>,
              and <code>extra_instructions</code>.
            </p>
          </div>

          <div class="panel-right">
            <div class="panel-section-title">
              Generated Test Code
              <span class="badge" id="testsBadge">No tests yet</span>
            </div>
            <pre id="testsOutput">// Generated test code will appear here…</pre>
            <div id="testsRagHits" style="margin-top:10px;"></div>
          </div>
        </div>
      </section>

      <!-- RAG PANEL -->
      <section id="tab-rag" class="tab-panel">
        <div class="rag-grid">
          <div class="rag-card">
            <header>
              <span>PDF Ingest</span>
              <span class="badge">POST /ingest/pdf</span>
            </header>
            <div class="rag-card-content">
              <div class="field">
                <label for="pdfFile">Upload PDF</label>
                <input id="pdfFile" type="file" accept="application/pdf" />
              </div>
              <div style="display:flex; gap:8px; align-items:center;">
                <button id="uploadPdfBtn" class="btn-secondary">
                  Upload &amp; ingest
                </button>
                <span id="pdfStatus" class="hint"></span>
              </div>
              <p class="hint" style="margin-top:6px;">
                Uses <code>session_id</code> + PDF file, splits to chunks and ingests into long-term memory.
              </p>

              <hr style="border:none; border-top:1px solid rgba(31,41,55,0.9); margin:8px 0;" />

              <header style="padding-top:0;">
                <span>Swagger Ingest</span>
                <span class="badge">POST /ingest/swagger</span>
              </header>
              <div class="field">
                <label for="swaggerUrl">OpenAPI/Swagger URL</label>
                <input
                  id="swaggerUrl"
                  type="text"
                  placeholder="e.g. https://my-service/swagger/v3/api-docs"
                />
              </div>
              <div style="display:flex; gap:8px; align-items:center;">
                <button id="ingestSwaggerBtn" class="btn-secondary">
                  Ingest Swagger
                </button>
                <span id="swaggerStatus" class="hint"></span>
              </div>
            </div>
          </div>

          <div class="rag-card">
            <header>
              <span>RAG Documents &amp; Chunks</span>
              <span class="badge">/rag/docs &amp; /rag/chunks</span>
            </header>
            <div style="display:flex; gap:6px; margin-bottom:6px;">
              <button id="listDocsBtn" class="btn-secondary">List docs</button>
              <button id="listChunksBtn" class="btn-secondary">List chunks</button>
              <span id="ragListStatus" class="hint"></span>
            </div>
            <div id="ragListOutput" class="rag-card-content">
              No RAG info loaded yet.
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // --- Helpers ---
    function randomSessionId() {
      return "session-" + Math.random().toString(36).slice(2, 10);
    }

    function nowTime() {
      const d = new Date();
      return d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function getBaseUrl() {
      const v = document.getElementById("baseUrl").value.trim();
      return v || "http://localhost:9090";
    }

    function getSessionId() {
      const input = document.getElementById("sessionId");
      if (!input.value.trim()) {
        input.value = randomSessionId();
      }
      return input.value.trim();
    }

    function setStatus(text) {
      document.getElementById("statusText").textContent = text;
    }

    // --- Tabs ---
    document.querySelectorAll(".tab").forEach((tab) => {
      tab.addEventListener("click", () => {
        const target = tab.getAttribute("data-tab");
        document.querySelectorAll(".tab").forEach((t) => t.classList.remove("active"));
        document.querySelectorAll(".tab-panel").forEach((p) => p.classList.remove("active"));
        tab.classList.add("active");
        document.getElementById("tab-" + target).classList.add("active");
      });
    });

    // Init session id
    document.getElementById("sessionId").value = randomSessionId();

    // --- Chat UI ---
    const chatContainer = document.getElementById("chatContainer");
    const chatEmpty = document.getElementById("chatEmpty");
    const chatInput = document.getElementById("chatInput");
    const sendChatBtn = document.getElementById("sendChatBtn");
    const typingIndicator = document.getElementById("typingIndicator");
    const useSameForRag = document.getElementById("useSameForRag");
    const ragQueryInput = document.getElementById("ragQueryInput");
    let sendingChat = false;

    function ensureChatNotEmpty() {
      if (chatEmpty) chatEmpty.remove();
    }

    function renderMessage(role, text) {
      ensureChatNotEmpty();
      const row = document.createElement("div");
      row.className = "msg-row " + (role === "user" ? "user" : "agent");

      const avatar = document.createElement("div");
      avatar.className = "msg-avatar " + (role === "user" ? "user" : "agent");
      avatar.textContent = role === "user" ? "You" : "A";

      const bubbleWrapper = document.createElement("div");
      const bubble = document.createElement("div");
      bubble.className = "msg-bubble";
      bubble.textContent = text;
      const meta = document.createElement("div");
      meta.className = "msg-meta";
      meta.textContent = (role === "user" ? "You" : "Agent") + " • " + nowTime();

      bubbleWrapper.appendChild(bubble);
      bubbleWrapper.appendChild(meta);

      if (role === "user") {
        row.appendChild(bubbleWrapper);
        row.appendChild(avatar);
      } else {
        row.appendChild(avatar);
        row.appendChild(bubbleWrapper);
      }

      chatContainer.appendChild(row);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function setChatSending(sending) {
      sendingChat = sending;
      sendChatBtn.disabled = sending;
      typingIndicator.style.display = sending ? "flex" : "none";
      setStatus(sending ? "Calling /chat…" : "Idle");
    }

    async function sendChat() {
      const chatHitsEl = document.getElementById("chatRagHits");
      if (chatHitsEl) chatHitsEl.innerHTML = "";
      const text = chatInput.value.trim();
      if (!text || sendingChat) return;

      const sessionId = getSessionId();
      const baseUrl = getBaseUrl();
      const ragOverride = ragQueryInput.value.trim();
      const query_for_rag = useSameForRag.checked ? text : (ragOverride || null);

      renderMessage("user", text);
      chatInput.value = "";
      chatInput.style.height = "20px";

      setChatSending(true);

      try {
        const payload = {
          session_id: sessionId,
          message: text,
          query_for_rag: query_for_rag,
        };

        const res = await fetch(baseUrl + "/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const body = await res.text();
          renderMessage("agent", `⚠️ /chat error (${res.status}): ${body || "No details"}`);
          return;
        }

        let data;
        try {
          data = await res.json();
        } catch {
          const txt = await res.text();
          renderMessage("agent", txt || "Empty response from /chat.");
          return;
        }

        const reply = data.reply ?? data.answer ?? JSON.stringify(data, null, 2);
        renderMessage("agent", reply);
        // Show which chunks were retrieved for this chat response
        const chatHitsEl = document.getElementById("chatRagHits");
        renderRagHitsInto(chatHitsEl, data.rag_hits || [], "Chunks retrieved for this chat response");

      } catch (e) {
        console.error(e);
        renderMessage("agent", "❌ Could not reach backend. Check URL & CORS.");
      } finally {
        setChatSending(false);
      }
    }

    chatInput.addEventListener("input", () => {
      chatInput.style.height = "20px";
      chatInput.style.height = chatInput.scrollHeight + "px";
    });

    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendChat();
      }
    });

    sendChatBtn.addEventListener("click", sendChat);

    // Quick prompts from sidebar + chips
    function wirePromptButtons(selector) {
      document.querySelectorAll(selector).forEach((btn) => {
        btn.addEventListener("click", () => {
          const prompt = btn.getAttribute("data-prompt");
          if (!prompt) return;
          chatInput.value = prompt;
          chatInput.dispatchEvent(new Event("input"));
          chatInput.focus();
        });
      });
    }

    wirePromptButtons(".pill");
    wirePromptButtons(".chip");

    // --- Generate Tests ---
    const servicePathEl = document.getElementById("servicePath");
    const extraInstrEl = document.getElementById("extraInstructions");
    const generateTestsBtn = document.getElementById("generateTestsBtn");
    const testsStatus = document.getElementById("testsStatus");
    const testsOutput = document.getElementById("testsOutput");
    const testsBadge = document.getElementById("testsBadge");
    let generatingTests = false;

    function setTestsStatus(text) {
      testsStatus.textContent = text;
    }

    async function generateTests() {
      const servicePath = servicePathEl.value.trim();
      if (!servicePath || generatingTests) {
        setTestsStatus(!servicePath ? "Service path required." : "");
        return;
      }

      const sessionId = getSessionId();
      const baseUrl = getBaseUrl();
      const extra = extraInstrEl.value || "";
      const hitsEl = document.getElementById("testsRagHits");
      if (hitsEl) hitsEl.innerHTML = "";
      generatingTests = true;
      generateTestsBtn.disabled = true;
      setTestsStatus("Calling /generate-tests…");
      setStatus("Calling /generate-tests…");

      try {
        const payload = {
          session_id: sessionId,
          service_path: servicePath,
          extra_instructions: extra,
        };

        const res = await fetch(baseUrl + "/generate-tests", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const body = await res.text();
          testsOutput.textContent = `// Error (${res.status}) from /generate-tests:\n${body || "No details"}`;
          testsBadge.textContent = "Error";
          return;
        }

        let data;
        try {
          data = await res.json();
        } catch {
          const txt = await res.text();
          testsOutput.textContent = txt || "// Empty response from /generate-tests";
          testsBadge.textContent = "Received";
          return;
        }

        const code = data.test_code ?? data.code ?? JSON.stringify(data, null, 2);
        testsOutput.textContent = code || "// No test code returned.";
        testsBadge.textContent = "Tests generated";
        const hitsEl = document.getElementById("testsRagHits");
        renderRagHitsInto(hitsEl, data.rag_hits || [], "Chunks retrieved for this test generation");

      } catch (e) {
        console.error(e);
        testsOutput.textContent = "// Failed to reach /generate-tests. Check URL & server.";
        testsBadge.textContent = "Error";
      } finally {
        generatingTests = false;
        generateTestsBtn.disabled = false;
        setTestsStatus("");
        setStatus("Idle");
      }
    }

    generateTestsBtn.addEventListener("click", generateTests);

    // --- RAG: PDF ingest & Swagger ---
    const pdfFileEl = document.getElementById("pdfFile");
    const uploadPdfBtn = document.getElementById("uploadPdfBtn");
    const pdfStatus = document.getElementById("pdfStatus");

    uploadPdfBtn.addEventListener("click", async () => {
      const file = pdfFileEl.files && pdfFileEl.files[0];
      if (!file) {
        pdfStatus.textContent = "Select a PDF first.";
        return;
      }
      const sessionId = getSessionId();
      const baseUrl = getBaseUrl();

      pdfStatus.textContent = "Uploading & ingesting…";
      setStatus("Calling /ingest/pdf…");

      const formData = new FormData();
      formData.append("session_id", sessionId);
      formData.append("file", file);

      try {
        const res = await fetch(baseUrl + "/ingest/pdf", {
          method: "POST",
          body: formData,
        });

        if (!res.ok) {
          const body = await res.text();
          pdfStatus.textContent = `Error (${res.status}): ${body || "No details"}`;
          return;
        }

        const data = await res.json();
        pdfStatus.textContent = `OK: ${data.chunks ?? "?"} chunks ingested.`;
      } catch (e) {
        console.error(e);
        pdfStatus.textContent = "Failed to reach /ingest/pdf.";
      } finally {
        setStatus("Idle");
      }
    });

    const swaggerUrlEl = document.getElementById("swaggerUrl");
    const ingestSwaggerBtn = document.getElementById("ingestSwaggerBtn");
    const swaggerStatus = document.getElementById("swaggerStatus");

    ingestSwaggerBtn.addEventListener("click", async () => {
      const url = swaggerUrlEl.value.trim();
      if (!url) {
        swaggerStatus.textContent = "Enter Swagger/OpenAPI URL.";
        return;
      }
      const baseUrl = getBaseUrl();
      swaggerStatus.textContent = "Calling /ingest/swagger…";
      setStatus("Calling /ingest/swagger…");

      try {
        const params = new URLSearchParams({ url });
        const res = await fetch(baseUrl + "/ingest/swagger?" + params.toString(), {
          method: "POST",
        });

        if (!res.ok) {
          const body = await res.text();
          swaggerStatus.textContent = `Error (${res.status}): ${body || "No details"}`;
          return;
        }

        const data = await res.json();
        swaggerStatus.textContent = `OK: doc_id=${data.doc_id || "?"}`;
      } catch (e) {
        console.error(e);
        swaggerStatus.textContent = "Failed to reach /ingest/swagger.";
      } finally {
        setStatus("Idle");
      }
    });

    // --- RAG: list docs/chunks (TABLE RENDERING) ---
    const listDocsBtn = document.getElementById("listDocsBtn");
    const listChunksBtn = document.getElementById("listChunksBtn");
    const ragListStatus = document.getElementById("ragListStatus");
    const ragListOutput = document.getElementById("ragListOutput");

    function escapeHtml(s) {
      return String(s ?? "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderRagHitsInto(containerEl, hits, title = "Chunks retrieved for this request") {
    if (!containerEl) return;

    if (!Array.isArray(hits) || hits.length === 0) {
      containerEl.innerHTML = `<div class="cell-muted">${escapeHtml(title)}: none</div>`;
      return;
    }

    const rows = hits.map((h, idx) => {
      const docId = h.doc_id ?? "";
      const score = h.score ?? "";
      const meta = h.meta ?? {};
      const source = meta.url || meta.filename || "";
      const sessionId = meta.session_id || "";
      const chunkIndex = meta.chunk_index ?? "";
      const totalChunks = meta.total_chunks ?? "";
      const preview = h.text_preview ?? "";
      const pid = `hitprev-${Date.now()}-${idx}`;

      return `
        <tr>
          <td class="mono">${escapeHtml(docId)}</td>
          <td class="cell-muted">${escapeHtml(score)}</td>
          <td class="mono">${escapeHtml(source)}</td>
          <td class="mono cell-muted">${escapeHtml(sessionId)}</td>
          <td class="cell-muted">${escapeHtml(chunkIndex)}/${escapeHtml(totalChunks)}</td>
          <td>
            <button class="small-btn" data-toggle="${pid}">View</button>
            <div id="${pid}" class="mono cell-muted" style="display:none; margin-top:6px;">
              ${escapeHtml(preview)}
            </div>
          </td>
        </tr>
      `;
    }).join("");

    containerEl.innerHTML = `
      <div class="badge" style="margin-bottom:6px;">${escapeHtml(title)}</div>
      <div class="table-wrap">
        <table class="rag-table">
          <thead>
            <tr>
              <th>doc_id</th>
              <th>score</th>
              <th>source</th>
              <th>session_id</th>
              <th>chunk</th>
              <th>preview</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;

    // Toggle preview
    containerEl.querySelectorAll("button[data-toggle]").forEach((btn) => {
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-toggle");
        const el = document.getElementById(id);
        if (!el) return;
        const open = el.style.display !== "none";
        el.style.display = open ? "none" : "block";
        btn.textContent = open ? "View" : "Hide";
      });
    });
  }
    function setRagHtml(html) {
      ragListOutput.innerHTML = html;
    }

    function renderDocsTable(data) {
      const docs = Array.isArray(data?.docs) ? data.docs : [];
      if (!docs.length) {
        setRagHtml(`<div class="cell-muted">No docs returned.</div>`);
        return;
      }

      const rows = docs.map((d) => {
        const docId = d.doc_id ?? d.id ?? "";
        const meta = d.meta ?? d.payload?.meta ?? {};
        const type = meta?.type ?? d.type ?? "";
        const filename = meta?.filename ?? "";
        const url = meta?.url ?? "";
        const sessionId = meta?.session_id ?? "";
        const chunkIndex = meta?.chunk_index ?? "";
        const totalChunks = meta?.total_chunks ?? "";
        const source = url || filename || "";

        return `
          <tr>
            <td class="mono">${escapeHtml(docId)}</td>
            <td>${escapeHtml(type)}</td>
            <td class="mono">${escapeHtml(source)}</td>
            <td class="mono cell-muted">${escapeHtml(sessionId)}</td>
            <td class="cell-muted">${escapeHtml(chunkIndex)}</td>
            <td class="cell-muted">${escapeHtml(totalChunks)}</td>
          </tr>
        `;
      }).join("");

      setRagHtml(`
        <div class="table-wrap">
          <table class="rag-table">
            <thead>
              <tr>
                <th>doc_id</th>
                <th>type</th>
                <th>source (url/filename)</th>
                <th>session_id</th>
                <th>chunk_index</th>
                <th>total_chunks</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `);
    }

    function renderChunksTable(data) {
      const chunks = Array.isArray(data?.chunks) ? data.chunks : [];
      if (!chunks.length) {
        setRagHtml(`<div class="cell-muted">No chunks returned.</div>`);
        return;
      }

      const rows = chunks.map((c, idx) => {
        const qdrantId = c.qdrant_id ?? "";
        const docId = c.doc_id ?? "";
        const meta = c.meta ?? {};
        const type = meta?.type ?? "";
        const filename = meta?.filename ?? "";
        const url = meta?.url ?? "";
        const sessionId = meta?.session_id ?? "";
        const chunkIndex = meta?.chunk_index ?? "";
        const totalChunks = meta?.total_chunks ?? "";
        const preview = c.text_preview ?? "";
        const previewId = `preview-${idx}`;

        return `
          <tr>
            <td class="mono">${escapeHtml(qdrantId)}</td>
            <td class="mono">${escapeHtml(docId)}</td>
            <td>${escapeHtml(type)}</td>
            <td class="mono">${escapeHtml(url || filename)}</td>
            <td class="mono cell-muted">${escapeHtml(sessionId)}</td>
            <td class="cell-muted">${escapeHtml(chunkIndex)}/${escapeHtml(totalChunks)}</td>
            <td>
              <button class="small-btn" data-toggle="${previewId}">View</button>
              <div id="${previewId}" class="mono cell-muted" style="display:none; margin-top:6px;">
                ${escapeHtml(preview)}
              </div>
            </td>
          </tr>
        `;
      }).join("");

      setRagHtml(`
        <div class="table-wrap">
          <table class="rag-table">
            <thead>
              <tr>
                <th>qdrant_id</th>
                <th>doc_id</th>
                <th>type</th>
                <th>source</th>
                <th>session_id</th>
                <th>chunk</th>
                <th>text_preview</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>
      `);

      ragListOutput.querySelectorAll("button[data-toggle]").forEach((btn) => {
        btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-toggle");
          const el = document.getElementById(id);
          if (!el) return;
          const isOpen = el.style.display !== "none";
          el.style.display = isOpen ? "none" : "block";
          btn.textContent = isOpen ? "View" : "Hide";
        });
      });
    }

    listDocsBtn.addEventListener("click", async () => {
      const baseUrl = getBaseUrl();
      ragListStatus.textContent = "Loading /rag/docs…";
      setStatus("Calling /rag/docs…");
      setRagHtml(`<div class="cell-muted">Loading docs…</div>`);

      try {
        const res = await fetch(baseUrl + "/rag/docs?limit=100");
        if (!res.ok) {
          const body = await res.text();
          setRagHtml(`<div class="mono">Error (${res.status}) from /rag/docs:\n${escapeHtml(body || "No details")}</div>`);
          ragListStatus.textContent = "";
          return;
        }
        const data = await res.json();
        renderDocsTable(data);
        ragListStatus.textContent = `${data.count ?? 0} docs.`;
      } catch (e) {
        console.error(e);
        setRagHtml(`<div class="cell-muted">Failed to reach /rag/docs.</div>`);
        ragListStatus.textContent = "";
      } finally {
        setStatus("Idle");
      }
    });

    listChunksBtn.addEventListener("click", async () => {
      const baseUrl = getBaseUrl();
      ragListStatus.textContent = "Loading /rag/chunks…";
      setStatus("Calling /rag/chunks…");
      setRagHtml(`<div class="cell-muted">Loading chunks…</div>`);

      try {
        const res = await fetch(baseUrl + "/rag/chunks?limit=20");
        if (!res.ok) {
          const body = await res.text();
          setRagHtml(`<div class="mono">Error (${res.status}) from /rag/chunks:\n${escapeHtml(body || "No details")}</div>`);
          ragListStatus.textContent = "";
          return;
        }
        const data = await res.json();
        renderChunksTable(data);
        ragListStatus.textContent = `${data.count ?? 0} chunks.`;
      } catch (e) {
        console.error(e);
        setRagHtml(`<div class="cell-muted">Failed to reach /rag/chunks.</div>`);
        ragListStatus.textContent = "";
      } finally {
        setStatus("Idle");
      }
    });

    // Server-Sent Events helper for test generation streaming
    function startTestGenerationStream(servicePath) {
      const baseUrl = getBaseUrl();
      const url = `${baseUrl}/generate-tests/stream?service_path=${encodeURIComponent(servicePath)}`;
      const evt = new EventSource(url);

      evt.onmessage = (e) => {
        try {
          const data = JSON.parse(e.data);
          console.log('SSE:', data);
          // update UI state using stage / partial fields if present
          if (data.stage === 'progress' && data.partial) {
            // append or display partial output somewhere — hook into your UI state
            // example: append to a pre element with id 'streamOutput'
            const out = document.getElementById('streamOutput');
            if (out) out.textContent += data.partial;
          }

          if (data.stage === 'done') {
            // final message, close the stream
            evt.close();
          }
        } catch (err) {
          console.error('Failed to parse SSE data', err, e.data);
        }
      };

      evt.onerror = (err) => {
        console.error('SSE error', err);
        // optionally close on errors or update status
      };

      return evt;
    }

    // Optional: wire to a button with id generateTestsBtn and an input with id servicePathInput
    const genBtn = document.getElementById('generateTestsBtn');
    const svcInput = document.getElementById('servicePathInput');
    if (genBtn && svcInput) {
      genBtn.addEventListener('click', () => {
        const svc = svcInput.value.trim();
        if (!svc) return alert('Enter service path');
        // clear output area
        const out = document.getElementById('streamOutput'); if (out) out.textContent = '';
        startTestGenerationStream(svc);
      });
    }
  </script>
</body>
</html>
